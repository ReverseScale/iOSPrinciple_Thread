# iOSPrinciple_Thread
Principle Thread

### ä¸€.ç›¸å…³æ¦‚å¿µ

#### 1.1 è¿›ç¨‹

è¿›ç¨‹æ˜¯æŒ‡åœ¨ç³»ç»Ÿä¸­æ­£åœ¨è¿è¡Œçš„ä¸€ä¸ªåº”ç”¨ç¨‹åºã€‚æ¯ä¸ªè¿›ç¨‹ä¹‹é—´æ˜¯ç‹¬ç«‹çš„ï¼Œæ¯ä¸ªè¿›ç¨‹å‡è¿è¡Œåœ¨å…¶ä¸“ç”¨ä¸”å—ä¿æŠ¤çš„å†…å­˜ç©ºé—´å†…ã€‚

#### 1.2 çº¿ç¨‹

*çº¿ç¨‹å’Œè¿›ç¨‹çš„å…³ç³»*

1ä¸ªè¿›ç¨‹è¦æƒ³æ‰§è¡Œä»»åŠ¡ï¼Œå¿…é¡»å¾—æœ‰çº¿ç¨‹ï¼ˆæ¯1ä¸ªè¿›ç¨‹è‡³å°‘è¦æœ‰1æ¡çº¿ç¨‹ï¼‰ï¼Œçº¿ç¨‹æ˜¯è¿›ç¨‹çš„åŸºæœ¬æ‰§è¡Œå•å…ƒï¼Œä¸€ä¸ªè¿›ç¨‹ï¼ˆç¨‹åºï¼‰çš„æ‰€æœ‰ä»»åŠ¡éƒ½åœ¨çº¿ç¨‹ä¸­æ‰§è¡Œã€‚

*çº¿ç¨‹å†…éƒ¨æ˜¯ä¸²è¡Œæ‰§è¡Œçš„*

1ä¸ªçº¿ç¨‹ä¸­ä»»åŠ¡çš„æ‰§è¡Œæ˜¯ä¸²è¡Œçš„ï¼Œå¦‚æœè¦åœ¨1ä¸ªçº¿ç¨‹ä¸­æ‰§è¡Œå¤šä¸ªä»»åŠ¡ï¼Œé‚£ä¹ˆåªèƒ½ä¸€ä¸ªä¸€ä¸ªåœ°æŒ‰é¡ºåºæ‰§è¡Œè¿™äº›ä»»åŠ¡ã€‚ä¹Ÿå°±æ˜¯è¯´ï¼Œåœ¨åŒä¸€æ—¶é—´å†…ï¼Œ1ä¸ªçº¿ç¨‹åªèƒ½æ‰§è¡Œ1ä¸ªä»»åŠ¡ã€‚

#### 1.3 å¤šçº¿ç¨‹

å³1ä¸ªè¿›ç¨‹ä¸­å¯ä»¥å¼€å¯å¤šæ¡çº¿ç¨‹ï¼Œæ¯æ¡çº¿ç¨‹å¯ä»¥å¹¶è¡Œï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œä¸åŒçš„ä»»åŠ¡ã€‚æ¯”å¦‚åŒæ—¶å¼€å¯3æ¡çº¿ç¨‹åˆ†åˆ«ä¸‹è½½3ä¸ªæ–‡ä»¶ï¼ˆåˆ†åˆ«æ˜¯æ–‡ä»¶Aã€æ–‡ä»¶Bã€æ–‡ä»¶Cï¼‰ã€‚

*å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„åŸç†*

åœ¨åŒä¸€æ—¶é—´é‡Œï¼ŒCPUåªèƒ½å¤„ç†1æ¡çº¿ç¨‹ï¼Œåªæœ‰1æ¡çº¿ç¨‹åœ¨å·¥ä½œï¼ˆæ‰§è¡Œï¼‰ã€‚å¤šçº¿ç¨‹å¹¶å‘ï¼ˆåŒæ—¶ï¼‰æ‰§è¡Œï¼Œå…¶å®æ˜¯CPUå¿«é€Ÿåœ°åœ¨å¤šæ¡çº¿ç¨‹ä¹‹é—´è°ƒåº¦ï¼ˆåˆ‡æ¢ï¼‰ï¼Œå¦‚æœCPUè°ƒåº¦çº¿ç¨‹çš„æ—¶é—´è¶³å¤Ÿå¿«ï¼Œå°±é€ æˆäº†å¤šçº¿ç¨‹å¹¶å‘æ‰§è¡Œçš„å‡è±¡ã€‚

*å¤šçº¿ç¨‹çš„ä¼˜ç¼ºç‚¹*

ä¼˜ç‚¹ï¼š
* 1ï¼‰èƒ½é€‚å½“æé«˜ç¨‹åºçš„æ‰§è¡Œæ•ˆç‡ã€‚
* 2ï¼‰èƒ½é€‚å½“æé«˜èµ„æºåˆ©ç”¨ç‡ï¼ˆCPUã€å†…å­˜åˆ©ç”¨ç‡ï¼‰

ç¼ºç‚¹ï¼š
* 1ï¼‰å¼€å¯çº¿ç¨‹éœ€è¦å ç”¨ä¸€å®šçš„å†…å­˜ç©ºé—´ï¼ˆé»˜è®¤æƒ…å†µä¸‹ï¼Œä¸»çº¿ç¨‹å ç”¨1Mï¼Œå­çº¿ç¨‹å ç”¨512KBï¼‰ï¼Œå¦‚æœå¼€å¯å¤§é‡çš„çº¿ç¨‹ï¼Œä¼šå ç”¨å¤§é‡çš„å†…å­˜ç©ºé—´ï¼Œé™ä½ç¨‹åºçš„æ€§èƒ½ã€‚
* 2ï¼‰çº¿ç¨‹è¶Šå¤šï¼ŒCPUåœ¨è°ƒåº¦çº¿ç¨‹ä¸Šçš„å¼€é”€å°±è¶Šå¤§ã€‚
* 3ï¼‰ç¨‹åºè®¾è®¡æ›´åŠ å¤æ‚ï¼šæ¯”å¦‚çº¿ç¨‹ä¹‹é—´çš„é€šä¿¡ã€å¤šçº¿ç¨‹çš„æ•°æ®å…±äº«

#### 1.4 å¤šçº¿ç¨‹åœ¨ iOS å¼€å‘ä¸­çš„åº”ç”¨

*iOS çš„ä¸»çº¿ç¨‹*

ä¸€ä¸ª iOS ç¨‹åºè¿è¡Œåï¼Œé»˜è®¤ä¼šå¼€å¯1æ¡çº¿ç¨‹ï¼Œç§°ä¸ºâ€œä¸»çº¿ç¨‹â€æˆ–â€œUIçº¿ç¨‹â€ï¼Œç”¨äºåˆ·æ–°æ˜¾ç¤ºUI,å¤„ç†UIäº‹ä»¶ã€‚
 
 > ä¸è¦å°†è€—æ—¶æ“ä½œæ”¾åˆ°ä¸»çº¿ç¨‹ä¸­å»å¤„ç†ï¼Œä¼šå¡ä½çº¿ç¨‹ã€‚

*iOS çš„å¤šçº¿ç¨‹*

1ï¼‰ç¬¬ä¸€ç§ï¼špthread

ç‰¹ç‚¹ï¼š
* ä¸€å¥—é€šç”¨çš„å¤šçº¿ç¨‹API
* é€‚ç”¨äºUnix\Linux\Windowsç­‰ç³»ç»Ÿ
* è·¨å¹³å°\å¯ç§»æ¤
* ä½¿ç”¨éš¾åº¦å¤§

ä½¿ç”¨è¯­è¨€ï¼šcè¯­è¨€

ä½¿ç”¨é¢‘ç‡ï¼šå‡ ä¹ä¸ç”¨

çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼šç”±ç¨‹åºå‘˜è¿›è¡Œç®¡ç†



2ï¼‰ç¬¬äºŒç§ï¼šNSThread

ç‰¹ç‚¹ï¼š
* ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡
* ç®€å•æ˜“ç”¨ï¼Œå¯ç›´æ¥æ“ä½œçº¿ç¨‹å¯¹è±¡

ä½¿ç”¨è¯­è¨€ï¼šOCè¯­è¨€

ä½¿ç”¨é¢‘ç‡ï¼šå¶å°”ä½¿ç”¨

çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼šç”±ç¨‹åºå‘˜è¿›è¡Œç®¡ç†



3ï¼‰ç¬¬ä¸‰ç§ï¼šGCD

ç‰¹ç‚¹ï¼š
* æ—¨åœ¨æ›¿ä»£NSThreadç­‰çº¿ç¨‹æŠ€æœ¯
* å……åˆ†åˆ©ç”¨è®¾å¤‡çš„å¤šæ ¸(è‡ªåŠ¨)

ä½¿ç”¨è¯­è¨€ï¼šOCè¯­è¨€

ä½¿ç”¨é¢‘ç‡ï¼šç»å¸¸ä½¿ç”¨

çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼šè‡ªåŠ¨ç®¡ç†



4ï¼‰ç¬¬å››ç§ï¼šNSOperation

ç‰¹ç‚¹ï¼š
* åŸºäºGCDï¼ˆåº•å±‚æ˜¯GCDï¼‰
* æ¯”GCDå¤šäº†ä¸€äº›æ›´ç®€å•å®ç”¨çš„åŠŸèƒ½
* ä½¿ç”¨æ›´åŠ é¢å‘å¯¹è±¡

> - åœ¨NSOperationQueueä¸­ï¼Œå¯ä»¥å»ºç«‹å„ä¸ªNSOperationä¹‹é—´çš„ä¾èµ–å…³ç³»
- æœ‰KVOï¼Œå¯ä»¥ç›‘æµ‹operationæ˜¯å¦æ­£åœ¨æ‰§è¡Œï¼ˆisExecutedï¼‰ã€æ˜¯å¦ç»“æŸï¼ˆisFinishedï¼‰ï¼Œæ˜¯å¦å–æ¶ˆï¼ˆisCanceldï¼‰
- NSOperationQueueå¯ä»¥æ–¹ä¾¿çš„ç®¡ç†å¹¶å‘ã€NSOperationä¹‹é—´çš„ä¼˜å…ˆçº§

ä½¿ç”¨è¯­è¨€ï¼šOCè¯­è¨€

ä½¿ç”¨é¢‘ç‡ï¼šç»å¸¸ä½¿ç”¨

çº¿ç¨‹ç”Ÿå‘½å‘¨æœŸï¼šè‡ªåŠ¨ç®¡ç†


### äºŒ.ä»£ç ç¤ºä¾‹

ç”±äºè¦ä½¿ç”¨ä¸€äº› c æ¥æ¼”ç¤ºï¼Œå…ˆè¯´æ˜äº›è§„èŒƒï¼Œé˜²æ‡µé€¼ ğŸ˜³
* 1.åœ¨cè¯­è¨€ä¸­ï¼Œæ²¡æœ‰å¯¹è±¡çš„æ¦‚å¿µï¼Œå¯¹è±¡ç±»å‹æ˜¯ä»¥-t/Refç»“å°¾çš„;
* 2.cè¯­è¨€ä¸­çš„void * å’ŒOCçš„idæ˜¯ç­‰ä»·çš„;
* 3.åœ¨æ··åˆå¼€å‘æ—¶ï¼Œå¦‚æœåœ¨ C å’Œ OC ä¹‹é—´ä¼ é€’æ•°æ®ï¼Œéœ€è¦ä½¿ç”¨ __bridge è¿›è¡Œæ¡¥æ¥ï¼Œæ¡¥æ¥çš„ç›®çš„å°±æ˜¯ä¸ºäº†å‘Šè¯‰ç¼–è¯‘å™¨å¦‚ä½•ç®¡ç†å†…å­˜ï¼ŒMRC ä¸­ä¸éœ€è¦ä½¿ç”¨æ¡¥æ¥;
* 4.åœ¨ OC ä¸­ï¼Œå¦‚æœæ˜¯ ARC å¼€å‘ï¼Œç¼–è¯‘å™¨ä¼šåœ¨ç¼–è¯‘æ—¶ï¼Œæ ¹æ®ä»£ç ç»“æ„ï¼Œ è‡ªåŠ¨æ·»åŠ  retain/release/autoreleaseã€‚ä½†æ˜¯ï¼ŒARC åªè´Ÿè´£ç®¡ç† OC éƒ¨åˆ†çš„å†…å­˜ç®¡ç†ï¼Œè€Œä¸è´Ÿè´£ C è¯­è¨€ ä»£ç çš„å†…å­˜ç®¡ç†ã€‚å› æ­¤ï¼Œå¼€å‘è¿‡ç¨‹ä¸­ï¼Œå¦‚æœä½¿ç”¨çš„ C è¯­è¨€æ¡†æ¶å‡ºç°retain/create/copy/new ç­‰å­—æ ·çš„å‡½æ•°ï¼Œå¤§å¤šéƒ½éœ€è¦ releaseï¼Œå¦åˆ™ä¼šå‡ºç°å†…å­˜æ³„æ¼ã€‚

#### 2.1 pthread åŸºæœ¬ä½¿ç”¨

éœ€è¦å¼•å…¥ pthread å¤´æ–‡ä»¶
```objc
#import <pthread.h>
```
ä½¿ç”¨ pthread_create æ–¹æ³•
```objc
/**
pthread_create(<#pthread_t  _Nullable *restrict _Nonnull#>, <#const pthread_attr_t *restrict _Nullable#>, <#void * _Nullable (* _Nonnull)(void * _Nullable)#>, <#void *restrict _Nullable#>)
å‚æ•°ï¼š
1.æŒ‡å‘çº¿ç¨‹æ ‡è¯†ç¬¦çš„æŒ‡é’ˆï¼ŒC è¯­è¨€ä¸­ç±»å‹çš„ç»“å°¾é€šå¸¸ _t/Refï¼Œè€Œä¸”ä¸éœ€è¦ä½¿ç”¨ *;
2.ç”¨æ¥è®¾ç½®çº¿ç¨‹å±æ€§;
3.æŒ‡å‘å‡½æ•°çš„æŒ‡é’ˆ,ä¼ å…¥å‡½æ•°å(å‡½æ•°çš„åœ°å€)ï¼Œçº¿ç¨‹è¦æ‰§è¡Œçš„å‡½æ•°/ä»»åŠ¡;
4.è¿è¡Œå‡½æ•°çš„å‚æ•°;
*/
```
å®Œæ•´ä»£ç 
```objc
{
    //1.åˆ›å»ºçº¿ç¨‹å¯¹è±¡
    pthread_t thread;

    //2.åˆ›å»ºçº¿ç¨‹
    NSString *param = @"å‚æ•°";
    int result = pthread_create(&thread, NULL, task, (__bridge void *)(param));
    result == 0?NSLog(@"success"):NSLog(@"failure");

    //3.è®¾ç½®å­çº¿ç¨‹çš„çŠ¶æ€è®¾ç½®ä¸ºdetached,åˆ™è¯¥çº¿ç¨‹è¿è¡Œç»“æŸåä¼šè‡ªåŠ¨é‡Šæ”¾æ‰€æœ‰èµ„æºï¼Œæˆ–è€…åœ¨å­çº¿ç¨‹ä¸­æ·»åŠ  pthread_detach(pthread_self()),å…¶ä¸­pthread_self()æ˜¯è·å¾—çº¿ç¨‹è‡ªèº«çš„id
    pthread_detach(thread);
}
void *task(void * param) {
    //åœ¨æ­¤åšè€—æ—¶æ“ä½œ
    NSLog(@"new thread : %@  å‚æ•°æ˜¯: %@",[NSThread currentThread],(__bridge NSString *)(param));
    return NULL;
}
```

#### 2.2 NSThread åŸºæœ¬ä½¿ç”¨

1.1ï¼‰ç¬¬ä¸€ç§ åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼šalloc init.

ç‰¹ç‚¹ï¼šéœ€è¦æ‰‹åŠ¨å¼€å¯çº¿ç¨‹ï¼Œå¯ä»¥æ‹¿åˆ°çº¿ç¨‹å¯¹è±¡è¿›è¡Œè¯¦ç»†è®¾ç½®

* ç¬¬ä¸€ä¸ªå‚æ•°ï¼šç›®æ ‡å¯¹è±¡
* ç¬¬äºŒä¸ªå‚æ•°ï¼šé€‰æ‹©å™¨ï¼Œçº¿ç¨‹å¯åŠ¨è¦è°ƒç”¨å“ªä¸ªæ–¹æ³•
* ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šå‰é¢æ–¹æ³•è¦æ¥æ”¶çš„å‚æ•°ï¼ˆæœ€å¤šåªèƒ½æ¥æ”¶ä¸€ä¸ªå‚æ•°ï¼Œæ²¡æœ‰åˆ™ä¼ nilï¼‰

```objc
NSThread *thread = [[NSThread alloc]initWithTarget:self selector:@selector(run) object:@"wendingding"];
//å¯åŠ¨çº¿ç¨‹
[thread start];
```

1.2ï¼‰ç¬¬äºŒç§ åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼šåˆ†ç¦»å‡ºä¸€æ¡å­çº¿ç¨‹

ç‰¹ç‚¹ï¼šè‡ªåŠ¨å¯åŠ¨çº¿ç¨‹ï¼Œæ— æ³•å¯¹çº¿ç¨‹è¿›è¡Œæ›´è¯¦ç»†çš„è®¾ç½®

* ç¬¬ä¸€ä¸ªå‚æ•°ï¼šçº¿ç¨‹å¯åŠ¨è°ƒç”¨çš„æ–¹æ³•
* ç¬¬äºŒä¸ªå‚æ•°ï¼šç›®æ ‡å¯¹è±¡
* ç¬¬ä¸‰ä¸ªå‚æ•°ï¼šä¼ é€’ç»™è°ƒç”¨æ–¹æ³•çš„å‚æ•°

```objc
[NSThread detachNewThreadSelector:@selector(run) toTarget:self withObject:@"æˆ‘æ˜¯åˆ†ç¦»å‡ºæ¥çš„å­çº¿ç¨‹"];
```

1.3ï¼‰ç¬¬ä¸‰ç§ åˆ›å»ºçº¿ç¨‹çš„æ–¹å¼ï¼šåå°çº¿ç¨‹

ç‰¹ç‚¹ï¼šè‡ªåŠ¨å¯åŠ¨å¿åŸï¼Œæ— æ³•è¿›è¡Œæ›´è¯¦ç»†è®¾ç½®

```objc
[self performSelectorInBackground:@selector(run) withObject:@"æˆ‘æ˜¯åå°çº¿ç¨‹"];
```

2ï¼‰å¸¸ç”¨çš„æ§åˆ¶çº¿ç¨‹æ–¹æ³•

ä¸ºçº¿ç¨‹å‘½åï¼Œä»¥ä¾¿åŒºåˆ†
```objc
//è®¾ç½®çº¿ç¨‹çš„åç§°
thread.name = @"çº¿ç¨‹A";
```

è®¾ç½®ä¼˜å…ˆçº§ï¼Œå–å€¼èŒƒå›´ä¸º0.0~1.0ä¹‹é—´ï¼Œ1.0è¡¨ç¤ºçº¿ç¨‹çš„ä¼˜å…ˆçº§æœ€é«˜,å¦‚æœä¸è®¾ç½®è¯¥å€¼ï¼Œé‚£ä¹ˆç†æƒ³çŠ¶æ€ä¸‹é»˜è®¤ä¸º0.5
```objc
//è®¾ç½®çº¿ç¨‹çš„ä¼˜å…ˆçº§
thread.threadPriority = 1.0;
```

é€€å‡ºå½“å‰çº¿ç¨‹
```objc
//é€€å‡ºå½“å‰çº¿ç¨‹
[NSThread exit];
```

çº¿ç¨‹çš„å„ç§çŠ¶æ€ï¼šæ–°å»º-å°±ç»ª-è¿è¡Œ-é˜»å¡-æ­»äº¡ï¼Œé˜»å¡çº¿ç¨‹æ–¹æ³•æ¥äº†
```objc
[NSThread sleepForTimeInterval:2.0]; //é˜»å¡çº¿ç¨‹
[NSThread sleepUntilDate:[NSDate dateWithTimeIntervalSinceNow:2.0]]; //é˜»å¡çº¿ç¨‹
//æ³¨æ„ï¼šçº¿ç¨‹æ­»äº†ä¸èƒ½å¤ç”Ÿ
```

3ï¼‰çº¿ç¨‹å®‰å…¨
* å‰æï¼šå¤šä¸ªçº¿ç¨‹è®¿é—®åŒä¸€å—èµ„æºä¼šå‘ç”Ÿæ•°æ®å®‰å…¨é—®é¢˜
* è§£å†³æ–¹æ¡ˆï¼šåŠ äº’æ–¥é”
* ç›¸å…³ä»£ç ï¼š@synchronized(self){}
* ä¸“ä¸šæœ¯è¯­-çº¿ç¨‹åŒæ­¥
* åŸå­å’ŒéåŸå­å±æ€§ï¼ˆæ˜¯å¦å¯¹setteræ–¹æ³•åŠ é”ï¼‰

æ­»é”ï¼šæ˜¯æŒ‡ä¸¤ä¸ªæˆ–ä¸¤ä¸ªä»¥ä¸Šçš„è¿›ç¨‹åœ¨æ‰§è¡Œè¿‡ç¨‹ä¸­ï¼Œå› äº‰å¤ºèµ„æºè€Œé€ æˆçš„ä¸€ç§äº’ç›¸ç­‰å¾…çš„ç°è±¡ï¼Œè‹¥æ— å¤–åŠ›ä½œç”¨ï¼Œå®ƒä»¬éƒ½å°†æ— æ³•æ¨è¿›ä¸‹å»ã€‚

äº§ç”Ÿæ­»é”çš„å››ä¸ªå¿…è¦æ¡ä»¶ï¼š
* äº’æ–¥æ¡ä»¶ï¼šä¸€ä¸ªèµ„æºæ¯æ¬¡åªèƒ½è¢«ä¸€ä¸ªè¿›ç¨‹ä½¿ç”¨ã€‚
* å æœ‰ä¸”ç­‰å¾…ï¼šä¸€ä¸ªè¿›ç¨‹å› è¯·æ±‚èµ„æºè€Œé˜»å¡æ—¶ï¼Œå¯¹å·²è·å¾—çš„èµ„æºä¿æŒä¸æ”¾ã€‚
* ä¸å¯å¼ºè¡Œå æœ‰:è¿›ç¨‹å·²è·å¾—çš„èµ„æºï¼Œåœ¨æœ«ä½¿ç”¨å®Œä¹‹å‰ï¼Œä¸èƒ½å¼ºè¡Œå‰¥å¤ºã€‚
* å¾ªç¯ç­‰å¾…æ¡ä»¶:è‹¥å¹²è¿›ç¨‹ä¹‹é—´å½¢æˆä¸€ç§å¤´å°¾ç›¸æ¥çš„å¾ªç¯ç­‰å¾…èµ„æºå…³ç³»ã€‚

äº§ç”Ÿæ­»é”çš„åŸå› ä¸»è¦æ˜¯ï¼š
* å› ä¸ºç³»ç»Ÿèµ„æºä¸è¶³ã€‚
* è¿›ç¨‹è¿è¡Œæ¨è¿›çš„é¡ºåºä¸åˆé€‚ã€‚
* èµ„æºåˆ†é…ä¸å½“ç­‰ã€‚

å”®ç¥¨å‘˜å”®ç¥¨é—®é¢˜
```objc
@interface NSThreadSafeViewController ()
//ä¸‰åªå”®ç¥¨å‘˜ğŸ±ğŸ¶ğŸ­
@property (nonatomic, strong) NSThread *thread01;
@property (nonatomic, strong) NSThread *thread02;
@property (nonatomic, strong) NSThread *thread03;
//æ€»ç¥¨æ•°
@property(nonatomic, assign) NSInteger totalticket;
@end

@implementation NSThreadSafeViewController

- (void)viewDidLoad {
    [super viewDidLoad];

    //å‡è®¾æœ‰10å¼ ç¥¨
    self.totalticket = 10;

    //åˆ›å»ºçº¿ç¨‹
    self.thread01 =  [[NSThread alloc]initWithTarget:self selector:@selector(saleTicket) object:nil];
    self.thread01.name = @"å°ğŸ±";

    self.thread02 =  [[NSThread alloc]initWithTarget:self selector:@selector(saleTicket) object:nil];
    self.thread02.name = @"å°ğŸ¶";

    self.thread03 =  [[NSThread alloc]initWithTarget:self selector:@selector(saleTicket) object:nil];
    self.thread03.name = @"å°ğŸ­";
}
- (void)touchesBegan:(NSSet<UITouch *> *)touches withEvent:(UIEvent *)event {
    //å¯åŠ¨çº¿ç¨‹
    [self.thread01 start];
    [self.thread02 start];
    [self.thread03 start];
}
//å”®ç¥¨
- (void)saleTicket {
    while (1) {
        //2.åŠ äº’æ–¥é”
        @synchronized(self) {
            [NSThread sleepForTimeInterval:0.03];
            //1.å…ˆæŸ¥çœ‹ä½™ç¥¨æ•°é‡
            NSInteger count = self.totalticket;
            if (count > 0) {
                self.totalticket = count - 1;
                NSLog(@"%@å–å‡ºå»äº†ä¸€å¼ ç¥¨,è¿˜å‰©ä¸‹%zdå¼ ç¥¨",[NSThread currentThread].name,self.totalticket);
            } else {
                NSLog(@"%@å‘ç°å½“å‰ç¥¨å·²ç»ä¹°å®Œäº†--",[NSThread currentThread].name);
                break;
            }
        }
    }
}
```

è¿è¡Œç»“æœï¼š

![](http://og1yl0w9z.bkt.clouddn.com/18-5-9/56476833.jpg)

4ï¼‰NSThread çº¿ç¨‹é—´é€šä¿¡ï¼ˆå­çº¿ç¨‹åŠ è½½å›¾ç‰‡å®Œæˆé€šçŸ¥ä¸»çº¿ç¨‹æ›´æ–°UIï¼‰
```objc
- (void)touchesBegan:(nonnull NSSet<UITouch *> *)touches withEvent:(nullable UIEvent *)event {
    //å¼€å¯ä¸€æ¡å­çº¿ç¨‹æ¥ä¸‹è½½å›¾ç‰‡
    [NSThread detachNewThreadSelector:@selector(downloadImage) toTarget:self withObject:nil];
}
- (void)downloadImage {
    //1.ç¡®å®šè¦ä¸‹è½½ç½‘ç»œå›¾ç‰‡çš„urlåœ°å€ï¼Œä¸€ä¸ªurlå”¯ä¸€å¯¹åº”ç€ç½‘ç»œä¸Šçš„ä¸€ä¸ªèµ„æº
    NSURL *url = [NSURL URLWithString:@"http://p6.qhimg.com/t01d2954e2799c461ab.jpg"];

    //2.æ ¹æ®urlåœ°å€ä¸‹è½½å›¾ç‰‡æ•°æ®åˆ°æœ¬åœ°ï¼ˆäºŒè¿›åˆ¶æ•°æ®
    NSData *data = [NSData dataWithContentsOfURL:url];

    //3.æŠŠä¸‹è½½åˆ°æœ¬åœ°çš„äºŒè¿›åˆ¶æ•°æ®è½¬æ¢æˆå›¾ç‰‡
    UIImage *image = [UIImage imageWithData:data];

    //4.å›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UI
    //4.1 ç¬¬ä¸€ç§æ–¹å¼
    //    [self performSelectorOnMainThread:@selector(showImage:) withObject:image waitUntilDone:YES];

    //4.2 ç¬¬äºŒç§æ–¹å¼
    //    [self.imageView performSelectorOnMainThread:@selector(setImage:) withObject:image waitUntilDone:YES];

    //4.3 ç¬¬ä¸‰ç§æ–¹å¼
    [self.imageView performSelector:@selector(setImage:) onThread:[NSThread mainThread] withObject:image waitUntilDone:YES];
}
```

5ï¼‰ç‰¹æ®Šç”¨æ³•ï¼ˆè®¡ç®—ä»£ç æ®µçš„æ‰§è¡Œæ—¶é—´ï¼‰
```objc
NSURL *url = [NSURL URLWithString:@"http://p6.qhimg.com/t01d2954e2799c461ab.jpg"];

//ç¬¬ä¸€ç§æ–¹æ³•
NSDate *start = [NSDate date];
//2.æ ¹æ®urlåœ°å€ä¸‹è½½å›¾ç‰‡æ•°æ®åˆ°æœ¬åœ°ï¼ˆäºŒè¿›åˆ¶æ•°æ®ï¼‰
NSData *data = [NSData dataWithContentsOfURL:url];

NSDate *end = [NSDate date];
NSLog(@"ç¬¬äºŒæ­¥æ“ä½œèŠ±è´¹çš„æ—¶é—´ä¸º%f",[end timeIntervalSinceDate:start]);


//ç¬¬äºŒç§æ–¹æ³•
CFTimeInterval start = CFAbsoluteTimeGetCurrent();
NSData *data = [NSData dataWithContentsOfURL:url];

CFTimeInterval end = CFAbsoluteTimeGetCurrent();
NSLog(@"ç¬¬äºŒæ­¥æ“ä½œèŠ±è´¹çš„æ—¶é—´ä¸º%f",end - start);
```

#### 2.3 GCD åŸºæœ¬ä½¿ç”¨

1ï¼‰GCD æ ¸å¿ƒæ¦‚å¿µ
* é˜Ÿåˆ—å’Œä»»åŠ¡
* åŒæ­¥å‡½æ•°å’Œå¼‚æ­¥å‡½æ•°

2ï¼‰GCD ç»„åˆæ‹³ ğŸ¤£

å¼‚æ­¥å‡½æ•°ï¼š
* å¼‚æ­¥å‡½æ•°+å¹¶å‘é˜Ÿåˆ—ï¼šå¼€å¯å¤šæ¡çº¿ç¨‹ï¼Œå¹¶å‘æ‰§è¡Œä»»åŠ¡
* å¼‚æ­¥å‡½æ•°+ä¸²è¡Œé˜Ÿåˆ—ï¼šå¼€å¯ä¸€æ¡çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡

åŒæ­¥å‡½æ•°ï¼š
* åŒæ­¥å‡½æ•°+å¹¶å‘é˜Ÿåˆ—ï¼šä¸å¼€çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡
* åŒæ­¥å‡½æ•°+ä¸²è¡Œé˜Ÿåˆ—ï¼šä¸å¼€çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡

ä¸»é˜Ÿåˆ—ï¼š
* å¼‚æ­¥å‡½æ•°+ä¸»é˜Ÿåˆ—ï¼šä¸å¼€çº¿ç¨‹ï¼Œåœ¨ä¸»çº¿ç¨‹ä¸­ä¸²è¡Œæ‰§è¡Œä»»åŠ¡
* åŒæ­¥å‡½æ•°+ä¸»é˜Ÿåˆ—ï¼šä¸å¼€çº¿ç¨‹ï¼Œä¸²è¡Œæ‰§è¡Œä»»åŠ¡ï¼ˆæ³¨æ„æ­»é”å‘ç”Ÿï¼‰

3ï¼‰GCD çº¿ç¨‹é—´é€šä¿¡
```objc
//0.è·å–ä¸€ä¸ªå…¨å±€çš„é˜Ÿåˆ—
dispatch_queue_t queue = dispatch_get_global_queue(0, 0);
//1.å…ˆå¼€å¯ä¸€ä¸ªçº¿ç¨‹ï¼ŒæŠŠä¸‹è½½å›¾ç‰‡çš„æ“ä½œæ”¾åœ¨å­çº¿ç¨‹ä¸­å¤„ç†
dispatch_async(queue, ^{
    //2.ä¸‹è½½å›¾ç‰‡
    NSURL *url = [NSURL URLWithString:@"http://h.hiphotos.baidu.com/zhidao/pic/item/6a63f6246b600c3320b14bb3184c510fd8f9a185.jpg"];
    NSData *data = [NSData dataWithContentsOfURL:url];
    UIImage *image = [UIImage imageWithData:data];

    NSLog(@"ä¸‹è½½æ“ä½œæ‰€åœ¨çš„çº¿ç¨‹--%@",[NSThread currentThread]);

    //3.å›åˆ°ä¸»çº¿ç¨‹åˆ·æ–°UI
    dispatch_async(dispatch_get_main_queue(), ^{
        self.imageView.image = image;
        //æ‰“å°æŸ¥çœ‹å½“å‰çº¿ç¨‹
        NSLog(@"åˆ·æ–°UI---%@",[NSThread currentThread]);
    });
});
```

4ï¼‰GCD å¸¸ç”¨å°åŠŸèƒ½

æ …æ å‡½æ•°ï¼ˆæ§åˆ¶ä»»åŠ¡çš„æ‰§è¡Œé¡ºåºï¼‰
```objc
dispatch_barrier_async(queue, ^{
    NSLog(@"--dispatch_barrier_async-");
});
```

å»¶è¿Ÿæ‰§è¡Œï¼ˆå»¶è¿ŸÂ·æ§åˆ¶åœ¨å“ªä¸ªçº¿ç¨‹æ‰§è¡Œï¼‰
```objc
dispatch_after(dispatch_time(DISPATCH_TIME_NOW, (int64_t)(2.0 * NSEC_PER_SEC)), dispatch_get_global_  queue(DISPATCH_QUEUE_PRIORITY_DEFAULT, 0), ^{
    NSLog(@"---%@",[NSThread currentThread]);
});
```

ä¸€æ¬¡æ€§ä»£ç ï¼ˆæ³¨æ„ä¸èƒ½æ”¾åˆ°æ‡’åŠ è½½ï¼‰
```objc
- (void)once {
    //æ•´ä¸ªç¨‹åºè¿è¡Œè¿‡ç¨‹ä¸­åªä¼šæ‰§è¡Œä¸€æ¬¡
    //onceTokenç”¨æ¥è®°å½•è¯¥éƒ¨åˆ†çš„ä»£ç æ˜¯å¦è¢«æ‰§è¡Œè¿‡
    static dispatch_once_t onceToken;
    dispatch_once(&onceToken, ^{
        NSLog(@"-----");
    });
}
```

å¿«é€Ÿè¿­ä»£ï¼ˆå¼€å¤šä¸ªçº¿ç¨‹å¹¶å‘å®Œæˆè¿­ä»£æ“ä½œï¼‰
```objc
dispatch_apply(subpaths.count, queue, ^(size_t index) {
});
```

é˜Ÿåˆ—ç»„ï¼ˆåŒæ …æ å‡½æ•°ï¼‰
```objc
//åˆ›å»ºé˜Ÿåˆ—ç»„
dispatch_group_t group = dispatch_group_create();
dispatch_queue_t globalQueue = dispatch_get_global_queue(0, 0);

dispatch_group_enter(group);
//æ¨¡æ‹Ÿå¤šçº¿ç¨‹è€—æ—¶æ“ä½œ
dispatch_group_async(group, globalQueue, ^{
    sleep(3);
    NSLog(@"%@---block1ç»“æŸã€‚ã€‚ã€‚",[NSThread currentThread]);
    dispatch_group_leave(group);
});
NSLog(@"%@---1ç»“æŸã€‚ã€‚ã€‚",[NSThread currentThread]);

dispatch_group_enter(group);
//æ¨¡æ‹Ÿå¤šçº¿ç¨‹è€—æ—¶æ“ä½œ
dispatch_group_async(group, globalQueue, ^{
    sleep(3);
    NSLog(@"%@---block2ç»“æŸã€‚ã€‚ã€‚",[NSThread currentThread]);
    dispatch_group_leave(group);
});
NSLog(@"%@---2ç»“æŸã€‚ã€‚ã€‚",[NSThread currentThread]);

dispatch_group_notify(group, globalQueue, ^{
    NSLog(@"%@---å…¨éƒ¨ç»“æŸã€‚ã€‚ã€‚",[NSThread currentThread]);
});
```

















